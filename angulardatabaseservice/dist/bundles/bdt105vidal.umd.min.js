!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("bdt105toolbox/dist")):"function"==typeof define&&define.amd?define(["exports","@angular/core","bdt105toolbox/dist"],e):e((t.ng=t.ng||{},t.ng.bdt105vidal={}),t.ng.core,t.dist)}(this,function(t,e,i){"use strict";var r=function(){function t(){}return t.prototype.setHeaders=function(t){void 0===t&&(t="text/xml");var e=new Headers;return e.append("Content-Type",t),e.append("Access-Control-Allow-Origin","*"),e},t.prototype.cleanId=function(t,e){var i=t+"";return Array.isArray(t)&&(i=t[0]+""),i.replace("vidal://"+e.toLowerCase()+"/","")},t.prototype.callback=function(t,e,i){e._body&&"string"==typeof e._body&&(e._body.startsWith("<?xml version")?e.json=this.toolbox.xml2json(e._body):e.json=this.toolbox.parseJson(e._body)),t&&t(e,i)},t.prototype.getApiBaseUrl=function(){var t=this.toolbox.readFromStorage("setting"),e=this.configuration.baseUrl;return t&&t.vidalBaseUrl&&(e=t.vidalBaseUrl),e},t.prototype.getHtmlStyle=function(){var t=this.toolbox.readFromStorage("setting"),e=this.configuration.alertsStyle;return t&&t.vidalHtmlStyle&&(e=t.vidalHtmlStyle),e},t.prototype.getApp_key=function(){return this.configuration.app_key},t.prototype.getApp_id=function(){return this.configuration.app_id},t.prototype.getUrlCredentials=function(t){return t+"app_id="+this.getApp_id()+"&app_key="+this.getApp_key()},t.prototype.search=function(t,e){if(e&&e.length>2){var i=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.search+"?q="+e+this.getUrlCredentials("&");this.rest.call(function(e,i){return t(e,i)},"GET",i,null,this.contentType)}},t.prototype.searchAllergies=function(t,e){if(e&&e.length>2){var i=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.searchAllergies+"?q="+e+this.getUrlCredentials("&");this.rest.call(function(e,i){return t(e,i)},"GET",i,null,this.contentType)}},t.prototype.getProducts=function(t,e){var i=this;if(t&&t.length>2){var r=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.search+"?q="+t+"&filter="+e+this.getUrlCredentials("&");this.rest.call(function(t,e){return i.callback(null,t,e)},"GET",r,null,this.contentType)}},t.prototype.getAllergies=function(t){var e=this;if(t&&t.length>2){var i=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.searchAllergies+"?q="+t+this.getUrlCredentials("&");this.rest.call(function(t,i){return e.callback(null,t,i)},"GET",i,null,this.contentType)}},t.prototype.getPathologies=function(t){var e=this;if(t&&t.length>2){var i=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.searchPathologies+"?q="+t+this.getUrlCredentials("&");this.rest.call(function(t,i){return e.callback(null,t,i)},"GET",i,null,this.contentType)}},t.prototype.searchPathologies=function(t,e,i){var r=this;if(i&&i.length>2){var n=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.searchPathologies+"?q="+i+this.getUrlCredentials("&");this.rest.call(function(t,e){return r.callback(null,t,e)},"GET",n,null,this.contentType)}},t.prototype.getFromId=function(t,e,i,r){var n=this;if(i&&r){var o=this.getApiBaseUrl()+this.configuration.apiDomain+"/"+i+"/"+r+this.getUrlCredentials("?");this.rest.call(function(t,e){return n.callback(null,t,e)},"GET",o,null,this.contentType)}},t.prototype.getPrescriptionUnits=function(t,e,i,r){var n=this;if(i&&r){var o=this.getApiBaseUrl()+this.configuration.apiDomain+"/"+i+"/"+r+"/units"+this.getUrlCredentials("?");this.rest.call(function(t,e){return n.callback(null,t,e)},"GET",o,null,this.contentType)}},t.prototype.getPrescriptionRoutes=function(t,e,i,r){var n=this;if(i&&r){var o=this.getApiBaseUrl()+this.configuration.apiDomain+"/"+i+"/"+r+"/routes"+this.getUrlCredentials("?");this.rest.call(function(t,e){return n.callback(null,t,e)},"GET",o,null,this.contentType)}},t.prototype.getIndications=function(t,e,i,r){var n=this;if(i&&r){var o=this.getApiBaseUrl()+this.configuration.apiDomain+"/"+i+"/"+r+"/indications"+this.getUrlCredentials("?");this.rest.call(function(t,e){return n.callback(null,t,e)},"GET",o,null,this.contentType)}},t.prototype.getPrescriptionLineXml=function(t){var e="<prescription-line>";return e+="<drug>vidal://"+t.productType+"/"+t.productId+"</drug>",e+="<dose>"+t.dose+"</dose>",e+="<unitId>"+t.unitId+"</unitId>",e+="<duration>"+t.duration+"</duration>",e+="<durationType>"+t.durationType+"</durationType>",e+="<frequencyType>"+t.frequencyType+"</frequencyType>",e+=t.routeId?"<routes><route>vidal://route/"+t.routeId+"</route></routes>":"",(e+=t.indicationId&&""!=t.indicationId?"<indications><indication>vidal://indication/"+t.indicationId+"</indication></indications>":"")+"</prescription-line>"},t.prototype.getBasicPatientXml=function(t){var e="";return t&&(e+=t.dateOfBirth?"<dateOfBirth>"+t.dateOfBirth.replace(" ","T")+"</dateOfBirth>":"",e+="<gender>"+t.gender+"</gender>",e+="<weight>"+t.weight+"</weight>",e+="<height>"+t.height+"</height>",e+=t.breastFeeding&&""!=t.breastFeeding&&"-1"!=t.breastFeeding?"<breastFeeding>"+t.breastFeeding+"</breastFeeding>":"",e+=t.weeksOfAmenorrhea&&""!=t.weeksOfAmenorrhea&&"-1"!=t.weeksOfAmenorrhea?"<weeksOfAmenorrhea>"+t.weeksOfAmenorrhea+"</weeksOfAmenorrhea>":"",e+=t.creatin&&""!=t.creatin&&null!=t.creatin&&"-1"!=t.creatin?"<creatin>"+t.creatin+"</creatin>":"",e+=t.hepaticInsufficiency&&""!=t.hepaticInsufficiency?"<hepaticInsufficiency>"+t.hepaticInsufficiency+"</hepaticInsufficiency>":""),e},t.prototype.getPatientXml=function(t){if(t){var e="<patient>";if(e+=this.getBasicPatientXml(t),t.allergyIds&&t.allergyIds.length>0){i=t.allergyIds.split("|");if(t.allergyIds.length>0){e+="<allergies>";for(r=0;r<i.length;r++)e+="<allergy>vidal://allergy/"+i[r]+"</allergy>";e+="</allergies>"}}if(t.moleculeIds&&t.moleculeIds.length>0){i=t.moleculeIds.split("|");if(t.moleculeIds.length>0){e+="<molecules>";for(r=0;r<i.length;r++)e+="<molecule>vidal://molecule/"+i[r]+"</molecule>";e+="</molecules>"}}if(t.cim10Ids&&t.cim10Ids.length>0){var i=t.cim10Ids.split("|");if(t.cim10Ids.length>0){e+="<pathologies>";for(var r=0;r<i.length;r++)e+="<pathology>vidal://cim10/"+i[r]+"</pathology>";e+="</pathologies>"}}return e+"</patient>"}return""},t.prototype.getPrescriptionXml=function(t){if(t){var e="<prescription-lines>";if(t.lines)for(var i=0;i<t.lines.length;i++)e+=this.getPrescriptionLineXml(t.lines[i]);e+="</prescription-lines>";return"<?xml version='1.0' encoding='UTF-8' standalone='yes'?><prescription>"+(t.patient?this.getPatientXml(t.patient):"")+e+"</prescription>"}return""},t.prototype.getAlerts=function(t,e,i,r){e&&e.lines&&e.lines.length>0&&(i.body=this.getPrescriptionXml(e),this.toolbox.log(i.body),i.url=this.getApiBaseUrl()+this.configuration.apiDomain+("html"==r?this.configuration.alertsHtml:this.configuration.alertsFull)+this.getUrlCredentials("?"),this.rest.call(function(e,i){return t(null,e,i)},"POST",i.url,i.body,this.contentType))},t.prototype.getAlertColor=function(t){var e={background:"red",font:""};switch(t){case"LEVEL_1":e.background="yellow",e.font="black";break;case"LEVEL_2":e.background="orange",e.font="white";break;case"LEVEL_3":e.background="#FF4326",e.font="white";break;case"LEVEL_4":e.background="red",e.font="white";break;case"INFO":e.background="#b1b1b1",e.font="black"}return e},t.prototype.getRelevantAlerts=function(t){var e=[];return t&&(t["vidal:maxAllergySeverity"]&&"NO_ALERT"!=t["vidal:maxAllergySeverity"][0].severity[0]&&(t["vidal:maxAllergySeverity"].tag="ALL",t["vidal:maxAllergySeverity"].color=this.getAlertColor(t["vidal:maxAllergySeverity"][0].severity[0]),e.push(t["vidal:maxAllergySeverity"])),t["vidal:maxContraIndicationSeverity"]&&"NO_ALERT"!=t["vidal:maxContraIndicationSeverity"][0].severity[0]&&(t["vidal:maxContraIndicationSeverity"].tag="CTI",t["vidal:maxContraIndicationSeverity"].color=this.getAlertColor(t["vidal:maxContraIndicationSeverity"][0].severity[0]),e.push(t.maxContraIndicationSeverity)),t["vidal:maxDrugDrugInteractionsSeverity"]&&"NO_ALERT"!=t["vidal:maxDrugDrugInteractionsSeverity"][0].severity[0]&&(t["vidal:maxDrugDrugInteractionsSeverity"].tag="INT",t["vidal:maxDrugDrugInteractionsSeverity"].color=this.getAlertColor(t["vidal:maxDrugDrugInteractionsSeverity"][0].severity[0]),e.push(t["vidal:maxDrugDrugInteractionsSeverity"])),t["vidal:maxPhysicoChemicalSeverity"]&&"NO_ALERT"!=t["vidal:maxPhysicoChemicalSeverity"][0].severity[0]&&(t["vidal:maxPhysicoChemicalSeverity"].tag="PCI",t["vidal:maxPhysicoChemicalSeverity"].color=this.getAlertColor(t["vidal:maxPhysicoChemicalSeverity"][0].severity[0]),e.push(t["vidal:maxPhysicoChemicalSeverity"])),t["vidal:maxPosologySeverity"]&&"NO_ALERT"!=t["vidal:maxPosologySeverity"][0].severity[0]&&(t["vidal:maxPosologySeverity"].tag="POS",t["vidal:maxPosologySeverity"].color=this.getAlertColor(t["vidal:maxPosologySeverity"][0].severity[0]),e.push(t["vidal:maxPosologySeverity"])),t["vidal:maxPrecautionSeverity"]&&"NO_ALERT"!=t["vidal:maxPrecautionSeverity"][0].severity[0]&&(t["vidal:maxPrecautionSeverity"].tag="PRS",t["vidal:maxPrecautionSeverity"].color=this.getAlertColor(t["vidal:maxPrecautionSeverity"][0].severity[0]),e.push(t["vidal:maxPrecautionSeverity"])),t["vidal:maxProcreationSeverity"]&&"NO_ALERT"!=t["vidal:maxProcreationSeverity"][0].severity[0]&&(t["vidal:maxProcreationSeverity"].tag="PRO",t["vidal:maxProcreationSeverity"].color=this.getAlertColor(t["vidal:maxProcreationSeverity"][0].severity[0]),e.push(t["vidal:maxProcreationSeverity"])),t["vidal:maxRedundantInteractionsSeverity"]&&"NO_ALERT"!=t["vidal:maxRedundantInteractionsSeverity"][0].severity[0]&&(t["vidal:maxRedundantInteractionsSeverity"].tag="RED",t["vidal:maxRedundantInteractionsSeverity"].color=this.getAlertColor(t["vidal:maxRedundantInteractionsSeverity"][0].severity[0]),e.push(t["vidal:maxRedundantInteractionsSeverity"]))),e},t.prototype.assignAlertsToLines=function(t,e){if(t&&e&&e.feed&&e.feed.entry)for(var i=0;i<t.lines.length;i++){var r=t.lines[i];r.alertSummary=[];for(var n=0;n<e.feed.entry.length;n++){var o=e.feed.entry[n];o.id[0].startsWith("vidal://prescription_line")&&o["vidal:drugId"][0]==r.productId&&(r.alertSummary=this.getRelevantAlerts(o))}}},t.prototype.addStyleToHtml=function(t,e,i){if(t&&this.getHtmlStyle()){var r="<style>";return r+=" "+this.configuration.alertsHtmlStyle,e&&(r+=this.configuration.alertsHtmlStyleHideSidebar),i&&(r+=" "+this.configuration.alertsHtmlStyleHideHeader),r+="</style>",t.replace("\x3c!-- custom-css --\x3e",r)}return t},t.prototype.getOptDocument=function(t,e,i){if(e&&i){var r=this.getApiBaseUrl()+this.configuration.apiDomain+"/"+e+"/"+i+"/documents/opt"+this.getUrlCredentials("?");this.rest.call(function(e,i){return t(e,i)},"GET",r,null,this.contentType)}},t.prototype.getDocuments=function(t,e,i,r){e&&i&&(r.url=this.getApiBaseUrl()+this.configuration.apiDomain+"/"+e+"/"+i+"/documents"+this.getUrlCredentials("?"),this.rest.call(function(e,i){return t(e,i)},"GET",r.url,null,this.contentType))},t.prototype.getATCClassFromProduct=function(t,e,i){if(e&&i){var r=this.getApiBaseUrl()+this.configuration.apiDomain+"/"+e+"/"+i+"/atc-classification"+this.getUrlCredentials("?");this.rest.call(function(e,i){return t(e,i)},"GET",r,null,this.contentType)}},t.prototype.getVIDALClassFromProduct=function(t,e,i){if(e&&i){var r=this.getApiBaseUrl()+this.configuration.apiDomain+"/"+e+"/"+i+"/vidal-classification"+this.getUrlCredentials("?");this.rest.call(function(e,i){return t(e,i)},"GET",r,null,this.contentType)}},t.prototype.getProduct=function(t,e,i){if(e&&i){var r=this.getApiBaseUrl()+this.configuration.apiDomain+"/"+e+"/"+i+this.getUrlCredentials("?");this.rest.call(function(e,i){return t(e,i)},"GET",r,null,this.contentType)}},t.prototype.getVigieAlerts=function(t,e){if(e&&e.patient){var i=e.patient.dateOfBirth.split("-"),r=(new Date).getFullYear()-i[0],n=[];if(e.lines&&e.lines.length>0)for(var o=0;o<e.lines.length;o++){var a={atcs:new Array,vidalClasses:new Array,galenicForms:new Array,indications:new Array,routes:new Array};e.lines[o].atcClass&&a.atcs.push(e.lines[o].atcClass),e.lines[o].vidalClass&&a.vidalClasses.push(e.lines[o].vidalClass),e.lines[o].galenicFormId&&a.galenicForms.push(e.lines[o].galenicFormId),e.lines[o].routeId&&a.routes.push(e.lines[o].routeId),n.push(a)}var l={age:r,prescriptions:n};this.toolbox.log(JSON.stringify(l));var s=this.configuration.urlVigie;this.rest.call(function(e,i){return t(e,i)},"POST",s,JSON.stringify(l),"application/json")}},t.prototype.getNewsFromProduct=function(t,e,i){if(e&&i&&("product"==e||"package"==e)){var r=this.getApiBaseUrl()+this.configuration.newsDomain+"/"+e+"/"+i+this.getUrlCredentials("?");this.rest.call(function(e,i){return t(e,i)},"GET",r,null,this.contentType)}},t.prototype.getPosologyXml=function(t,e,i){var r="",n="",o="<patient>"+this.getBasicPatientXml(t)+"</patient>";if(e&&e.length>0){r="<routes>";for(a=0;a<e.length;a++)r+="<route>vidal://route/"+e[a]+"</route>";r+="</routes>"}if(i&&i.length>0){n="<indications>";for(var a=0;a<i.length;a++)n+="<indication>vidal://indication/"+i[a]+"</indication>";n+="</indications>"}return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><posology-request>'+o+r+n+"</posology-request>"},t.prototype.getPosologyFromProduct=function(t,e,i,r,n,o,a){e&&i&&r&&(a.url=this.getApiBaseUrl()+this.configuration.apiDomain+"/"+e+"/"+i+"/posology-descriptors"+this.getUrlCredentials("?"),a.body=this.getPosologyXml(r,n,o),this.rest.call(function(e,i){return t(e,i)},"POST",a.url,a.body,this.contentType))},t.prototype.getUnitIdFromFrequency=function(t){return this.frequencyToUnitId.filter(function(e){return e.key==t})[0].value},t.prototype.getFrequencyFromUnitId=function(t){if(t){return this.frequencyToUnitId.filter(function(e){return e.value==t})[0].key}return""},t.prototype.getPostComplementXml=function(t,e,i){var r='<?xml version="1.0" encoding="UTF-8"?><request>';if(t&&t.length>0){r+="<drugs>";for(n=0;n<t.length;n++)r+="<id>"+t[n]+"</id>";r+="</drugs>"}if(e&&e.length>0){r+="<codesToControl>";for(var n=0;n<e.length;n++)r+="<codeToControl>"+e[n]+"</codeToControl>";r+="</codesToControl>"}return i&&i.length>0&&(r+="<text>"+i+"</text>"),r+="<engine>VIDAL</engine><drugCursor>DEFAULT</drugCursor></request>"},t.prototype.getPostComplement=function(t,e,i,r,n){(e&&e.length>0||r&&r.length>0)&&(n.url=this.getApiBaseUrl()+this.configuration.pmsiDomain+this.configuration.postComplement+this.getUrlCredentials("?"),n.body=this.getPostComplementXml(e,i,r),this.rest.call(function(e,i){return t(e,i)},"POST",n.url,n.body,this.contentType))},t.prototype.getCim10FromIndicationGroupId=function(t,e){if(e){var i=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.indicationGroup+"/"+e+"/cim10s"+this.getUrlCredentials("?");this.rest.call(function(e,i){return t(e,i)},"GET",i,null,this.contentType)}},t.prototype.getRecosFromIndicationGroupId=function(t,e){if(e){var i=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.indicationGroup+"/"+e+"/recos"+this.getUrlCredentials("?");this.rest.call(function(e,i){return t(e,i)},"GET",i,null,this.contentType)}},t.prototype.getPrescriptionRecos=function(t,e,i){i.body=this.getPrescriptionXml(e),i.url=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.prescriptionRecos+this.getUrlCredentials("?"),this.toolbox.log(e.xmlBody),this.rest.call(function(e,i){return t(e,i)},"POST",i.url,i.body,this.contentType)},t.prototype.getRecoUrl=function(t){return this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.reco+"/"+t+"/html"+this.getUrlCredentials("?")},t.prototype.getReco=function(t,e){this.rest.call(function(e,i){return t(e,i)},"GET",this.getRecoUrl(e),null,this.contentType)},t.prototype.getAdaptedDugsXml=function(t,e,i,r){var n="<adapted-drugs>";if(n+="<vmp-id>"+t+"</vmp-id>",n+="<output-drug-type>PRODUCT</output-drug-type>",n+="<facets>",e)for(var o=0;o<e.length;o++)e[o].active&&(n+='<facet name="'+e[o]["vidal:facetName"][0].name[0]+'" value="'+e[o]["vidal:facetValue"][0]+'"/>');return n+="</facets>",n+="<start-page>"+i+"</start-page>",n+="<page-size>"+r+"</page-size>",n+="</adapted-drugs>"},t.prototype.getAdaptedDrugs=function(t,e,i,r,n,o){e&&(o.body=this.getAdaptedDugsXml(e,i,r,n),o.url=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.adaptedDrugs+this.getUrlCredentials("?"),this.toolbox.log(o.xmlBody),this.rest.call(function(e,i){return t(e,i)},"POST",o.url,o.body,this.contentType))},t.prototype.getSideEffectsXml=function(t,e){var i="<?xml version='1.0' encoding='UTF-8' standalone='yes'?><adapted-drugs>";if(i+="<request>",i+="<ids>",t)for(var r=0;r<t.length;r++)i+="<id>"+t[r]+"</id>";return i+="</ids>",i+="<sideEffectId>"+e+"</sideEffectId>",i+="</request>"},t.prototype.getSideEffects=function(t,e,i,r){i&&(r.body=this.getSideEffectsXml(e,i),r.url=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.sideEffectSort+this.getUrlCredentials("?"),this.toolbox.log(r.xmlBody),this.rest.call(function(e,i){return t(e,i)},"POST",r.url,r.body,this.contentType))},t.prototype.getVigieHtml=function(t,e){if(t.json&&t.json.feed&&t.json.feed.entry){for(var i="",r=0;r<t.json.feed.entry.length;r++){i+=t.json.feed.entry[r].summary}return"<div class='notificationVigie'><h1>"+e+"</h1>"+i+"</div>"}},t.prototype.getVersion=function(t,e,i){void 0===i&&(i=null),e.url=this.getApiBaseUrl()+this.configuration.apiDomain+this.configuration.version+(i?"?"+i:this.getUrlCredentials("?")),this.rest.call(function(e,i){return t(e,i)},"GET",e.url,null,this.contentType)},t.prototype.flattenObject=function(t){if(t.isArray()&&1==t.length){if("string"==typeof t[0])return t[0];if(t[0]._)return t[0]._}return"string"==t._?t._:t},t}();t.VidalService=r,Object.defineProperty(t,"__esModule",{value:!0})});